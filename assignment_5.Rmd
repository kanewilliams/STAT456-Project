---
title: "Assignment 5 - Decomposing New Zealand wholesale electricity prices using stl() and str()"
author:
  - name: Kane Williams (pkw21@uclive.ac.nz)
link-citations: true
subtitle: STAT456-24S2 - Time Series and Stochastic Processes
header-includes:
   - \usepackage{amsmath}
output:
  html_document:
    toc: true
    toc_float: true
    highlight: tango
    theme: flatly
editor_options:
  markdown:
    wrap: 72
---

```{=html}
<style>

.boxTask {
background-color: lightblue;
color: black;
border: 2px solid black;
margin: 5px;
padding: 5px;
font-style: italic;
}

/* Centered headings */
h1, h2, h3, h4, h5, h6 {
  text-align: center;
}

</style>
```


```{r echo=FALSE}
source("./src/packages.R")
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 80), tidy = TRUE)
```

```{=html}
<style>

.boxTask {
background-color: lightblue;
color: black;
border: 2px solid black;
margin: 5px;
padding: 5px;
font-style: italic;
}

/* Centered headings */
h1, h2, h3, h4, h5, h6 {
  text-align: center;
}

</style>
```

In this assignment/project, New Zealand's wholesale electricity prices will be decomposed using two different methods. The results and the residuals will be compared.

# Introduction

## New Zealand's Wholesale electricity market

New Zealand's electricity market was liberalised in BLA BLA.

## Introduction to stl() and str()

stl() is an R package that allows decomposing a time series into two components.

str() is a recent R package by ...

::: boxTask
Bla bla ba
:::

# Data Import

The dataset chosen was: **Wholesale price trends**.

-   It was pulled from the [Electricity Authority](https://www.emi.ea.govt.nz/Wholesale/Reports/W_P_C?DateFrom=20140101&DateTo=20240101&RegionType=NZ&TimeScale=DAY&_si=_dr_DateFrom|20140101,_dr_DateTo|20240101,_dr_RegionType|NZ,_dr_TimeScale|TP,v|4) with the
    following parameters:
    -   **Date Range**: 01 Jan 2014 - 01 Jan 2024
    -   **Region Type**: New Zealand
    -   **Time Scale** Trading Period (i.e. half-hourly data)

```{r}
# READ DATA
file_path <- "./data/NZ_Wholesale_Electricity_Prices_2014-2024.csv"
header <- c("Period_Start", "Period_End", "Region_ID", "Region", "Price")

raw_data <- read_csv(file_path, 
                     skip = 12, 
                     col_names = header,
                     show_col_types = FALSE) %>%
  mutate(
    Price = as.numeric(Price),
    Period_Start = dmy_hms(Period_Start),
    Period_End = dmy_hms(Period_End)
  )
```

```{r}
# FILTER DATA (for ease of use)

use_hourly = 1
use_only_one_year = 1

filtered_data <- raw_data %>%
  # Select hourly (instead of half-hourly)
  dplyr::filter(if (use_hourly == 1) row_number() %% 2 == 1 else TRUE) %>%
  # Select relevant columns
  dplyr::select(Period_Start, Price) %>%
  # Only one year
  dplyr::filter(if (use_only_one_year == 1) year(Period_Start) == 2023 else TRUE)

head(filtered_data, 3)
```


```{r}
# CREATE ts OBJECT
frequency <- 24  # Hourly data for a year

elec_ts <- ts(filtered_data$Price, 
                     start = c(2023, 1), 
                     frequency = frequency)

# Print first few rows to verify
print(head(elec_ts))
```

```{r}
# Create TSIBBLE object
elec_tsibble <- tsibble(
  Datetime = filtered_data$Period_Start,
  Price = filtered_data$Price,
  index = Datetime
)

print(head(elec_tsibble))
print(range(elec_tsibble$Datetime))
```

`tsibble` conveniently loads half-hourly data, where `ts` struggles.

# Decomposition using stl()

```{r}
# plot(stl(elec_ts, s.window=168))
```

```{r}

# # STL decomposition
# stl_decomp <- elec_tsibble %>%
#   model(STL(Price ~ season(period = "day") + season(period = "week") + season(period = "year")))
# 
# # Plot the decomposition
# components(stl_decomp) %>% autoplot()
```


It was found that ...

# Decomposition using str()

```{r}
# TODO

```

Bla bla bla...

# Bibliography

https://otexts.com/fpp2/complexseasonality.html

https://cran.r-project.org/web/packages/stR/vignettes/stRvignette.html

https://www.wessa.net/download/stl.pdf


